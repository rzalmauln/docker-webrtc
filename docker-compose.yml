version: "3.8"

services:
  nginx:
    image: nginx:stable-alpine
    container_name: nginx_stream
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./html:/var/www/html              # ← UBAH: untuk serve HTML player
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - mediamtx
    networks:
      - stream_network

  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: mediamtx
    restart: unless-stopped
    ports:
      - "8554:8554"      # RTSP
      - "8888:8888"      # HLS (tambahkan jika butuh)
      - "8889:8889"      # WebRTC
      - "8189:8189/udp"  # WebRTC UDP
      - "9997:9997"      # API (tambahkan untuk monitoring)
    env_file: .env
    volumes:
      - ./mediamtx.yml:/mediamtx.yml
    networks:
      - stream_network

  # ffmpeg:
  #   image: jrottenberg/ffmpeg:4.4-ubuntu
  #   container_name: ffmpeg_hikvision
  #   command: >
  #     -rtsp_transport tcp
  #            -i "rtsp://admin:Hiksds12@192.168.3.64:554/Streaming/Channels/101"
  #            -c:v copy 
  #            -f hls 
  #            -hls_time 2 
  #            -hls_list_size 3
  #            -hls_flags delete_segments
  #            /var/www/streams/index.m3u8
  #   volumes:
  #     - ./streams:/var/www/streams

  node_listener:
    build: ./node_listener   # ← folder berisi source Node.js
    container_name: node_listener
    restart: unless-stopped
    environment:
      CAMERA_URL: "http://admin:Hiksds12@192.168.3.64/ISAPI/Event/notification/alertStream"
      BACKEND_API_URL: "http://100.73.50.49:8000" # ← IP Tailscale laptop + port backend
    depends_on:
      - mediamtx
    networks:
      - stream_network
      
networks:
  stream_network:
    driver: bridge